<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Боевая База - Google Sheets</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #c1a270 0%, #d4b886 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(193, 162, 112, 0.3);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 500;
            text-align: center;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1rem;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: white;
            color: #c1a270;
        }

        /* Main Content */
        .main {
            padding: 2rem 0;
            min-height: calc(100vh - 120px);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #c1a270;
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .success {
            text-align: center;
            padding: 1rem;
            color: #155724;
            background: #d4edda;
            border-radius: 10px;
            margin: 1rem 0;
        }

        /* Participants Grid */
        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .participant-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .participant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .participant-header {
            background: linear-gradient(135deg, #c1a270 0%, #d4b886 100%);
            padding: 1.5rem;
            text-align: center;
            color: white;
            position: relative;
        }

        .score-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #c1a270;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .participant-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            border: 3px solid white;
            object-fit: cover;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        }

        .participant-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .participant-role {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .participant-info {
            padding: 1.5rem;
        }

        .participant-bio {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .participant-weapons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .weapon-info {
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.85rem;
            border-left: 3px solid #c1a270;
        }

        .weapon-label {
            font-weight: 600;
            color: #c1a270;
        }

        /* Profile Styles */
        .profile {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, #c1a270 0%, #d4b886 100%);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        .profile-score {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #c1a270;
            padding: 1rem 1.5rem;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .profile-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            border: 5px solid white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            object-fit: cover;
            background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
        }

        .profile-name {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .profile-bio {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-content {
            padding: 2rem;
        }

        .profile-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #c1a270;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weapon-card, .equipment-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .weapon-card:hover, .equipment-card:hover {
            border-color: #c1a270;
            transform: translateY(-2px);
        }

        .weapon-title {
            font-weight: 600;
            color: #c1a270;
            margin-bottom: 0.5rem;
        }

        .equipment-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .equipment-item {
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            border-left: 3px solid #c1a270;
            font-size: 0.9rem;
        }

        .back-btn {
            background: #c1a270;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #a68a5b;
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            margin-bottom: 1rem;
            margin-left: 1rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        /* Leaderboard */
        .sort-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .sort-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            background: #5a6268;
        }

        .sort-btn.active {
            background: #c1a270;
        }

        .status-info {
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            .profile-avatar {
                width: 120px;
                height: 120px;
            }

            .profile-name {
                font-size: 1.5rem;
            }

            .container {
                padding: 0 15px;
            }

            .score-badge, .profile-score {
                position: static;
                display: inline-block;
                margin-top: 1rem;
            }

            .sort-controls {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>Боевая База</h1>
            <nav class="nav">
                <button class="nav-btn active" onclick="showParticipants()">Участники</button>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Participants Section -->
            <div id="participantsSection">
                <button class="refresh-btn" onclick="loadParticipants()">🔄 Обновить данные</button>
                
                <div class="sort-controls">
                    <button class="sort-btn active" onclick="sortBy('default')">По умолчанию</button>
                    <button class="sort-btn" onclick="sortBy('score')">По баллам ⬇</button>
                    <button class="sort-btn" onclick="sortBy('name')">По имени</button>
                </div>
                
                <div id="loadingMessage" class="loading hidden">Загрузка данных из Google Таблиц...</div>
                <div id="errorMessage" class="error hidden"></div>
                <div id="successMessage" class="success hidden"></div>
                <div id="statusInfo" class="status-info">
                    <strong>✅ Таблица подключена!</strong><br>
                    Используется опубликованная Google Таблица.<br>
                    Нажмите "Обновить данные" для загрузки актуальной информации.
                </div>
                <div class="participants-grid" id="participantsContainer">
                    <!-- Participants will be dynamically loaded here -->
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="hidden">
                <button class="back-btn" onclick="showParticipants()">← Назад к участникам</button>
                <div class="profile" id="profileContainer">
                    <!-- Profile will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // Конфигурация Google Sheets
        const GOOGLE_SHEETS_CONFIG = {
            // Извлекаем ID из опубликованного URL
            publishedId: '2PACX-1vSyv3bAifxY2clEjSnLpiSFm3RwRULCbbuk19HGQYBiRmE-Llq81jmk5kalFY8v07Vt4DODTxltvVZa',
            gid: '0' // ID листа (0 для первого листа)
        };

        let profiles = {};
        let currentSort = 'default';

        // Функции для работы с изображениями
        function getImageUrl(avatarUrl) {
            if (!avatarUrl || avatarUrl.trim() === '') {
                return getDefaultAvatar('User');
            }
            
            // Если это уже data URL или полный URL, возвращаем как есть
            if (avatarUrl.startsWith('data:') || avatarUrl.startsWith('http')) {
                return avatarUrl;
            }
            
            // Если это Google Drive ссылка, конвертируем в прямую ссылку
            if (avatarUrl.includes('drive.google.com')) {
                return convertGoogleDriveUrl(avatarUrl);
            }
            
            // Если это относительный путь, возвращаем как есть
            return avatarUrl;
        }

        function convertGoogleDriveUrl(url) {
            // Конвертируем Google Drive ссылки в прямые ссылки на изображения
            const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (fileIdMatch) {
                return `https://drive.google.com/uc?export=view&id=${fileIdMatch[1]}`;
            }
            return url;
        }

        function getDefaultAvatar(name, size = 80) {
            // Создаем аватар с инициалами
            const initials = name ? name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : '?';
            const colors = [
                '#c1a270', '#e74c3c', '#3498db', '#2ecc71', '#f39c12', 
                '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#e91e63'
            ];
            const colorIndex = name ? name.length % colors.length : 0;
            const bgColor = colors[colorIndex];
            
            const svg = `
                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="${size}" height="${size}" rx="${size/2}" fill="${bgColor}"/>
                    <text x="${size/2}" y="${size/2 + 8}" text-anchor="middle" fill="white" font-size="${size/3}" font-family="Arial, sans-serif" font-weight="bold">${initials}</text>
                </svg>
            `;
            
            return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        }

        // Функция для предварительной загрузки изображений
        function preloadImage(url) {
            return new Promise((resolve, reject) => {
                if (!url || url.startsWith('data:')) {
                    resolve(url);
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(url);
                img.onerror = () => reject(new Error('Failed to load image'));
                img.src = url;
                
                // Timeout для изображений
                setTimeout(() => reject(new Error('Image load timeout')), 5000);
            });
        }

        // Функция для загрузки данных из Google Sheets
        async function loadDataFromGoogleSheets() {
            const loadingEl = document.getElementById('loadingMessage');
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            const statusEl = document.getElementById('statusInfo');
            
            try {
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                successEl.classList.add('hidden');
                statusEl.classList.add('hidden');

                // Попробуем несколько вариантов URL для Google Sheets
                const urls = [
                    `https://docs.google.com/spreadsheets/d/e/${GOOGLE_SHEETS_CONFIG.publishedId}/pub?gid=${GOOGLE_SHEETS_CONFIG.gid}&single=true&output=csv`,
                    `https://docs.google.com/spreadsheets/d/e/${GOOGLE_SHEETS_CONFIG.publishedId}/pub?output=csv`,
                    // Используем CORS прокси как запасной вариант
                    `https://api.allorigins.win/get?url=${encodeURIComponent(`https://docs.google.com/spreadsheets/d/e/${GOOGLE_SHEETS_CONFIG.publishedId}/pub?gid=${GOOGLE_SHEETS_CONFIG.gid}&single=true&output=csv`)}`
                ];
                
                let response = null;
                let csvText = '';
                let usedProxy = false;
                
                // Пробуем загрузить данные с разных URL
                for (let i = 0; i < urls.length; i++) {
                    try {
                        console.log(`Попытка ${i + 1}: Загружаем данные с URL:`, urls[i]);
                        
                        if (i === 2) { // Последний URL - это прокси
                            usedProxy = true;
                            response = await fetch(urls[i], {
                                method: 'GET',
                                cache: 'no-cache'
                            });
                            
                            if (response.ok) {
                                const proxyData = await response.json();
                                csvText = proxyData.contents;
                            }
                        } else {
                            response = await fetch(urls[i], {
                                method: 'GET',
                                mode: 'cors',
                                cache: 'no-cache'
                            });
                            
                            if (response.ok) {
                                csvText = await response.text();
                            }
                        }
                        
                        if (csvText && csvText.trim()) {
                            console.log(`Успешно загружено с URL ${i + 1}${usedProxy ? ' (через прокси)' : ''}`);
                            break; // Выходим из цикла при успешной загрузке
                        }
                    } catch (fetchError) {
                        console.log(`Ошибка при загрузке с URL ${i + 1}:`, fetchError.message);
                        if (i === urls.length - 1) {
                            throw fetchError; // Если все URL не сработали, выбрасываем последнюю ошибку
                        }
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error(`Не удалось загрузить данные ни с одного URL. Проверьте настройки доступа к таблице.`);
                }
                
                
                if (!csvText.trim()) {
                    throw new Error('Получен пустой ответ. Проверьте настройки доступа к таблице.');
                }

                console.log('Получены данные CSV, длина:', csvText.length);
                console.log('Первые 200 символов:', csvText.substring(0, 200));

                // Парсим CSV данные
                const rows = parseCSV(csvText);
                
                if (rows.length < 2) {
                    throw new Error('В таблице должна быть хотя бы одна строка с данными (кроме заголовков)');
                }

                console.log('Найдено строк:', rows.length);
                console.log('Заголовки:', rows[0]);

                // Преобразуем данные из CSV в объект профилей
                profiles = {};
                let validProfiles = 0;
                
                // Пропускаем первую строку (заголовки)
                rows.slice(1).forEach((row, index) => {
                    if (row.length >= 3 && row[0]?.trim()) { // Минимум имя, биография, роль
                        const id = index + 1;
                        profiles[id] = {
                            id: id,
                            name: row[0]?.trim() || 'Не указано',
                            bio: row[1]?.trim() || 'Биография не указана',
                            avatar: row[2]?.trim() || '',
                            favoriteWeapon: row[3]?.trim() || 'Не указано',
                            additionalWeapon: row[4]?.trim() || 'Не указано',
                            equipment: row[5] ? row[5].split(',').map(item => item.trim()).filter(item => item) : [],
                            role: row[6]?.trim() || 'Оператор',
                            experience: row[7]?.trim() || 'Не указано',
                            score: parseInt(row[8]?.trim()) || Math.floor(Math.random() * 100) // Случайные баллы если не указаны
                        };
                        validProfiles++;
                        console.log(`Профиль ${id}:`, profiles[id]);
                    }
                });

                if (validProfiles === 0) {
                    throw new Error('Не найдено валидных данных профилей. Проверьте формат данных в таблице.');
                }

                loadingEl.classList.add('hidden');
                successEl.innerHTML = `✅ Успешно загружено ${validProfiles} профилей из Google Таблиц${usedProxy ? ' (через прокси-сервер)' : ''}`;
                successEl.classList.remove('hidden');
                
                displayParticipants();
                
                console.log('Данные успешно загружены:', validProfiles, 'профилей');
                
                // Скрыть сообщение об успехе через 3 секунды
                setTimeout(() => {
                    successEl.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                loadingEl.classList.add('hidden');
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    errorEl.innerHTML = `
                        <strong>Ошибка сети (CORS):</strong> Не удается подключиться к Google Таблицам напрямую.<br><br>
                        <strong>Решения:</strong><br>
                        1. <strong>Рекомендуется:</strong> Загрузите файл на веб-сервер (например, GitHub Pages, Netlify)<br>
                        2. Используйте локальный сервер (например, Live Server в VS Code)<br>
                        3. Откройте Chrome с флагом: <code>--disable-web-security --user-data-dir=/tmp/chrome_dev</code><br><br>
                        <strong>Альтернатива:</strong> Попробуйте открыть файл через веб-сервер вместо file:// протокола<br><br>
                        <em>Показываем демо-данные для демонстрации...</em>
                    `;
                } else {
                    errorEl.innerHTML = `
                        <strong>Ошибка загрузки:</strong> ${error.message}<br><br>
                        <strong>Проверьте:</strong><br>
                        1. Таблица опубликована для публичного доступа<br>
                        2. В таблице есть данные (минимум: Имя, Биография, Аватар)<br>
                        3. Первая строка содержит заголовки<br>
                        4. Файл открыт через веб-сервер, а не file:// протокол<br><br>
                        <em>Показываем демо-данные для примера...</em>
                    `;
                }
                
                errorEl.classList.remove('hidden');
                statusEl.innerHTML = `
                    <strong>⚠️ Проблема с подключением к таблице</strong><br>
                    Для корректной работы с Google Sheets необходим веб-сервер.<br>
                    <strong>Решение:</strong> Разместите файл на хостинге или используйте локальный сервер.
                `;
                statusEl.classList.remove('hidden');
                
                // Показываем демо-данные в случае ошибки
                loadDemoData();
            }
        }

        // Простой парсер CSV с улучшенной обработкой
        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');
            
            for (let line of lines) {
                line = line.trim();
                if (line) {
                    // Улучшенный парсинг CSV с обработкой кавычек и запятых внутри полей
                    const row = [];
                    let currentField = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        
                        if (char === '"') {
                            if (inQuotes && line[i + 1] === '"') {
                                // Экранированная кавычка
                                currentField += '"';
                                i++; // Пропускаем следующую кавычку
                            } else {
                                // Начало или конец поля в кавычках
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            // Разделитель поля
                            row.push(currentField.trim());
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    
                    // Добавляем последнее поле
                    row.push(currentField.trim());
                    
                    // Только добавляем строки с данными
                    if (row.some(field => field.length > 0)) {
                        rows.push(row);
                    }
                }
            }
            
            return rows;
        }

        // Демо данные для тестирования
        function loadDemoData() {
            profiles = {
                1: {
                    id: 1,
                    name: "Алексей Волков",
                    bio: "Опытный оператор спецназа с 8-летним стажем. Специализируется на тактических операциях и обучении новобранцев.",
                    avatar: "https://randomuser.me/api/portraits/men/1.jpg",
                    favoriteWeapon: "АК-74М",
                    additionalWeapon: "Пистолет Макарова",
                    equipment: [
                        "Бронежилет 6Б43",
                        "Шлем 6Б47",
                        "Ночные очки НВД",
                        "Тактический рюкзак",
                        "Средства связи",
                        "Медицинская аптечка"
                    ],
                    role: "Оператор",
                    experience: "8 лет",
                    score: 85
                },
                2: {
                    id: 2,
                    name: "Сергей Петров",
                    bio: "Снайпер высокого класса, мастер дальнего боя. Участник международных соревнований по стрельбе.",
                    avatar: "https://randomuser.me/api/portraits/men/2.jpg",
                    favoriteWeapon: "СВД",
                    additionalWeapon: "АКС-74У",
                    equipment: [
                        "Оптический прицел",
                        "Сошки для винтовки",
                        "Маскировочный костюм",
                        "Лазерный дальномер",
                        "Баллистический компьютер",
                        "Защитные наушники"
                    ],
                    role: "Снайпер",
                    experience: "6 лет",
                    score: 92
                },
                3: {
                    id: 3,
                    name: "Мария Козлова",
                    bio: "Медик подразделения, специалист по полевой хирургии и экстренной медицинской помощи.",
                    avatar: "https://randomuser.me/api/portraits/women/1.jpg",
                    favoriteWeapon: "АКС-74У",
                    additionalWeapon: "Пистолет ПЯ",
                    equipment: [
                        "Медицинский рюкзак",
                        "Дефибриллятор",
                        "Хирургический набор",
                        "Обезболивающие",
                        "Бинты и жгуты",
                        "Антибиотики"
                    ],
                    role: "Медик",
                    experience: "5 лет",
                    score: 78
                },
                4: {
                    id: 4,
                    name: "Дмитрий Смирнов",
                    bio: "Специалист по взрывчатым веществам и разминированию. Эксперт в области инженерного обеспечения боевых действий.",
                    avatar: "", // Пустая ссылка для демонстрации работы аватара по умолчанию
                    favoriteWeapon: "АКС-74",
                    additionalWeapon: "Сигнальный пистолет",
                    equipment: [
                        "Набор сапера",
                        "Детектор металла",
                        "Взрывчатые вещества",
                        "Средства связи",
                        "Защитный костюм",
                        "Инструменты"
                    ],
                    role: "Сапер",
                    experience: "7 лет",
                    score: 89
                }
            };
            displayParticipants();
        }

        // Функции сортировки
        function sortBy(type) {
            // Обновляем активную кнопку
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentSort = type;
            displayParticipants();
        }

        function getSortedProfiles() {
            const profilesArray = Object.values(profiles);
            
            switch(currentSort) {
                case 'score':
                    return profilesArray.sort((a, b) => b.score - a.score);
                case 'name':
                    return profilesArray.sort((a, b) => a.name.localeCompare(b.name));
                default:
                    return profilesArray.sort((a, b) => a.id - b.id);
            }
        }

        // Функции навигации
        function showParticipants() {
            document.getElementById('participantsSection').classList.remove('hidden');
            document.getElementById('profileSection').classList.add('hidden');
            
            // Обновляем активную кнопку навигации
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.nav-btn').classList.add('active');
        }

        function showProfile(userId) {
            document.getElementById('participantsSection').classList.add('hidden');
            document.getElementById('profileSection').classList.remove('hidden');
            loadProfile(userId);
        }

        // Загрузка участников
        function loadParticipants() {
            loadDataFromGoogleSheets();
        }

        function displayParticipants() {
            const container = document.getElementById('participantsContainer');
            
            if (Object.keys(profiles).length === 0) {
                container.innerHTML = '<div class="error">Нет данных для отображения</div>';
                return;
            }
            
            const sortedProfiles = getSortedProfiles();
            
            container.innerHTML = sortedProfiles.map(profile => `
                <div class="participant-card" onclick="showProfile(${profile.id})">
                    <div class="participant-header">
                        <div class="score-badge">${profile.score} 🏆</div>
                        <img src="${getImageUrl(profile.avatar)}" alt="${profile.name}" class="participant-avatar" onerror="this.src='${getDefaultAvatar(profile.name)}'" loading="lazy" crossorigin="anonymous">
                        <div class="participant-name">${profile.name}</div>
                        <div class="participant-role">${profile.role}</div>
                    </div>
                    <div class="participant-info">
                        <div class="participant-bio">${profile.bio}</div>
                        <div class="participant-weapons">
                            <div class="weapon-info">
                                <span class="weapon-label">Основное оружие:</span> ${profile.favoriteWeapon}
                            </div>
                            <div class="weapon-info">
                                <span class="weapon-label">Дополнительное:</span> ${profile.additionalWeapon}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Загрузка профиля
        function loadProfile(userId) {
            const profile = profiles[userId];
            if (!profile) {
                document.getElementById('profileContainer').innerHTML = '<div class="error">Профиль не найден</div>';
                return;
            }

            const equipmentList = profile.equipment && profile.equipment.length > 0 
                ? profile.equipment.map(item => `<div class="equipment-item">${item}</div>`).join('')
                : '<div class="equipment-item">Снаряжение не указано</div>';

            document.getElementById('profileContainer').innerHTML = `
                <div class="profile-header">
                    <div class="profile-score">${profile.score} 🏆</div>
                    <img src="${getImageUrl(profile.avatar)}" alt="${profile.name}" class="profile-avatar" onerror="this.src='${getDefaultAvatar(profile.name, 150)}'" loading="lazy" crossorigin="anonymous">
                    <div class="profile-name">${profile.name}</div>
                    <div class="profile-bio">${profile.bio}</div>
                </div>
                <div class="profile-content">
                    <div class="profile-section">
                        <div class="section-title">🎖️ Информация</div>
                        <div class="weapon-card">
                            <div class="weapon-title">Роль:</div>
                            <div>${profile.role}</div>
                        </div>
                        <div class="weapon-card">
                            <div class="weapon-title">Опыт службы:</div>
                            <div>${profile.experience}</div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <div class="section-title">🔫 Вооружение</div>
                        <div class="weapon-card">
                            <div class="weapon-title">Основное оружие</div>
                            <div>${profile.favoriteWeapon}</div>
                        </div>
                        <div class="weapon-card">
                            <div class="weapon-title">Дополнительное оружие</div>
                            <div>${profile.additionalWeapon}</div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <div class="section-title">🎒 Снаряжение</div>
                        <div class="equipment-card">
                            <div class="equipment-list">
                                ${equipmentList}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Страница загружена, запускаем загрузку данных...');
            loadDataFromGoogleSheets();
        });

        // Автоматическое обновление каждые 5 минут
        setInterval(() => {
            console.log('Автоматическое обновление данных...');
            loadDataFromGoogleSheets();
        }, 300000); // 5 минут

    </script>
</body>
</html>